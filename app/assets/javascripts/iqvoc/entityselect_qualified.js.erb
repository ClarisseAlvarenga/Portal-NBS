// EntitySelector extension for qualified entities

/*jslint vars: true, unparam: true, white: true */
/*global jQuery, IQVOC */

IQVOC.QualifiedEntitySelector = (function($) {

"use strict";

var QualifiedEntitySelector = function(args) {
	var res = IQVOC.EntitySelector.apply(this, arguments);
	this.qualified = this.el.data("qualified") || false; // TODO: document (NB: doubles as i18n)
	if(this.qualified) {
		this.container.on("change", "input.qualified", this.onQualify);
	}
	return res;
};
QualifiedEntitySelector.prototype = new IQVOC.EntitySelector();

QualifiedEntitySelector.prototype.onQualify = function(ev) {
	var el = $(this),
		entity = el.closest("li"),
		widget = el.closest(".entity_select").data("widget"),
		id = entity.data("id"),
		value = id + ":" + el.val();
	widget.remove(id);
	widget.add(value);
};

QualifiedEntitySelector.prototype.createEntity = function(entity) {
	var node = IQVOC.EntitySelector.prototype.createEntity.apply(this, arguments);
	if(this.qualified) {
		var el = $(node).children(":first"); // XXX: breaks encapsulation
		$('<input class="rank" />').attr("placeholder", this.qualified).
				insertAfter(el);
	}
	return node;
};

return QualifiedEntitySelector;

}(jQuery));
