<%= render 'header', :concept => @concept %>

<% if @new_concept_version.blank? && can?(:branch, @concept) %>
  <% if @jobs.any? %>
    <%= render partial: 'partials/concept/reverse_match_notice', locals: {concept: @concept, jobs: @jobs} %>
  <% end %>
    <div class="editing_versioning_toolbar well">
      <%= button_to t('txt.views.versioning.versioning_mode'),
        concept_versions_branch_path(:origin => @concept.origin), :class => 'btn btn-default' %>
    </div>
<% elsif can?(:read, @new_concept_version) %>
    <div class="editing_versioning_toolbar well">
      <%= link_to t('txt.views.versioning.preview_new_version'),
        concept_path(:published => 0, :id => @new_concept_version), :class => 'btn btn-default' %>
    </div>
<% end %>

<% if @view.definition %>
  <blockquote>
    <%= @view.definition %> <%# FIXME: `auto_link` throws "undefined method `empty?' for #<Note::SKOS::Definition:...>" %>
  </blockquote>
<% end %>

<ul class="nav nav-tabs"> <%# TODO: create generic partial? %>
  <% @view.languages.each_with_index do |lang, i| %>
    <%= content_tag('li', :class => ('active' if lang['active'])) do %>
      <a href="#<%= lang['id'] %>" data-toggle="tab"><%= lang['caption'] %></a>
    <% end %>
  <% end %>

  <div class="tab-content col-md-12"> <%# XXX: grid column without row? %>
    <% @view.languages.each_with_index do |lang, i| %> <%# XXX: excessive logic; move into view model? %>
    <div class="tab-pane <%= 'active' if lang['active'] %>" id="<%= lang['id'] %>">
      <section class="labels">
        <% [[:pref_labels, 'pref-label', 'txt.common.pref_label'],
            [:alt_labels, 'alt-label', 'txt.common.alt_label']].
          each do |label_type, klass, caption| %>
        <% @view.send(label_type)[lang['id']].try(:each) do |label| %>
          <span title="<%= t(caption) %>" class="<%= klass %>"><%= label %></span>
        <% end %>
      <% end %>
      </section>

      <section class="notes row">
        <% @view.notes[lang['id']].each do |caption, notes| %>
          <% notes.each do |note, annotations| %>
          <div class="col-sm-6">
            <article class="panel">
              <h4><%= caption %></h4>

              <% if note %>
              <p><%= auto_link(note, :html => { :target => '_blank' }) %></p>
              <% end %>

              <% if annotations %>
              <dl class="note_annotations">
                <% annotations.each do |annotation| %>
                  <dt><%= annotation.identifier %></dt>
                  <dd><%= auto_link(annotation.value, :html => { :target => '_blank' }) %></dd>
                <% end %>
              </dl>
              <% end %>
            </article>
          </div>
          <% end %>
        <% end %>
      </section>
    </div> <!-- .tab-pane -->
    <% end %>
  </div>
</ul>

<ul class="representations list-group">
  <% @view.representations.each do |repr| %>
  <li class="list-group-item">
    <% if repr['type'] == :rdf %>
      <img src="<%= asset_path "rdf_flyer.svg" %>" title="RDF">
    <% else %>
      <%= icon('link') %>
    <% end %>
    <%= link_to repr['caption'], repr['uri'] %>
  </li>
  <% end %>
</ul>

<%= render 'layouts/sections', :sections => Iqvoc::Concept.view_sections, :data => concept_view_data(@concept) %>
